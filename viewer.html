<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Price Viewer</title>
    <!-- Add Socket.io client library -->
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
        }

        .timestamp {
            font-size: 0.8em;
            color: #666;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: red;
            margin-left: 10px;
        }

        .status-indicator.connected {
            background-color: green;
        }
    </style>
</head>

<body>
    <h1>
        Gold Products from <span id="seller"></span>
        <span class="status-indicator" id="connection-status"></span>
    </h1>
    <div id="products"></div>

    <script>
        const locationPath = window.location.pathname.split("/");
        const key = locationPath[locationPath.length - 1];
        document.getElementById('seller').innerText = decodeURIComponent(key);

        // Initialize Socket.io connection
        const socket = io();
        const statusIndicator = document.getElementById('connection-status');

        // Connection event handlers
        socket.on('connect', () => {
            console.log('Connected to server');
            statusIndicator.classList.add('connected');
            // Subscribe to updates for this seller
            socket.emit('subscribe', key);
            
            // Get initial data
            fetchInitialData();
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            statusIndicator.classList.remove('connected');
        });

        // Listen for price updates
        socket.on('priceUpdate', (data) => {
            if (data.seller === key) {
                updateProductsDisplay(data.products);
            }
        });

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN');
        }

        // Fetch initial data when page loads
        async function fetchInitialData() {
            try {
                const response = await fetch(`/get/${key}`);
                if (response.ok) {
                    const products = await response.json();
                    updateProductsDisplay(products);
                } else {
                    document.getElementById('products').innerHTML = '<p>Failed to fetch data</p>';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('products').innerHTML = '<p>Error retrieving data</p>';
            }
        }

        // Update the display with product data
        function updateProductsDisplay(products) {
            if (!products || products.length === 0) {
                document.getElementById('products').innerHTML = '<p>No products available</p>';
                return;
            }

            let html = `
                <table>
                    <tr>
                        <th>Product Type</th>
                        <th>Selling Price</th>
                        <th>Buying Price</th>
                        <th>Last Updated</th>
                    </tr>
            `;

            products.forEach(product => {
                html += `
                    <tr>
                        <td>${product.type}</td>
                        <td>${formatCurrency(product.sellPrice)}</td>
                        <td>${formatCurrency(product.buyPrice)}</td>
                        <td><span class="timestamp">${formatDate(product.updatedAt)}</span></td>
                    </tr>
                `;
            });

            html += '</table>';
            document.getElementById('products').innerHTML = html;
        }
    </script>
</body>

</html>