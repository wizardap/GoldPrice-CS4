<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Theo dõi giá vàng</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  <style>
    .price-card {
      transition: background-color 0.5s ease;
    }

    .price-up {
      background-color: rgba(76, 175, 80, 0.2) !important;
    }

    .price-down {
      background-color: rgba(244, 67, 54, 0.2) !important;
    }

    .gold-type {
      font-weight: bold;
      color: #D4AF37;
    }

    .timestamp {
      font-size: 0.8rem;
      color: #6c757d;
    }

    .price-change {
      font-weight: bold;
    }

    .price-increase {
      color: #28a745;
    }

    .price-decrease {
      color: #dc3545;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">
        <i class="bi bi-coin"></i> Theo dõi giá vàng
      </a>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row">
      <div class="col-12">
        <div class="card shadow-sm mb-4">
          <div class="card-header d-flex justify-content-between align-items-center bg-warning text-dark">
            <h5 class="mb-0" id="vendor-title">Đang tải...</h5>
            <span class="badge bg-dark" id="connection-status">Đang kết nối...</span>
          </div>
          <div class="card-body">
            <div class="timestamp text-end mb-2">Cập nhật lần cuối: <span id="last-update">--/--/---- --:--:--</span>
            </div>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Loại vàng</th>
                    <th class="text-end">Giá mua (VNĐ)</th>
                    <th class="text-end">Giá bán (VNĐ)</th>
                    <th class="text-end">Chênh lệch</th>
                  </tr>
                </thead>
                <tbody id="price-table-body">
                  <tr>
                    <td colspan="4" class="text-center">Đang tải dữ liệu...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Lấy vendor ID từ URL và chuyển sang lowercase
    const locationPath = window.location.pathname.split("/");
    const vendorId = locationPath[locationPath.length - 1].toLowerCase();

    // Data management
    let lastPrices = {};

    // Định dạng số tiền
    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN').format(amount);
    }

    // Định dạng thời gian
    function formatDate(date) {
      if (!date) return '--/--/---- --:--:--';
      const d = new Date(date);
      return d.toLocaleString('vi-VN');
    }

    // Cập nhật DOM với dữ liệu mới nhất
    function updateUI(data) {
      // Cập nhật thông tin vendor
      document.getElementById('vendor-title').innerText = `Giá vàng - ${vendorId.toUpperCase()}`;
      document.getElementById('last-update').innerText = formatDate(data.timestamp);

      // Cập nhật bảng giá
      const tableBody = document.getElementById('price-table-body');
      tableBody.innerHTML = '';

      if (data.value && Array.isArray(data.value)) {
        data.value.forEach(product => {
          // Tính chênh lệch giá
          const difference = product.sellPrice - product.buyPrice;
          const differencePercent = ((difference / product.buyPrice) * 100).toFixed(2);

          // Calculate change since last price
          let priceChangeHtml = '';
          if (lastPrices[product.type]) {
            const priceChange = product.sellPrice - lastPrices[product.type].sellPrice;
            const priceChangePercent = ((priceChange / lastPrices[product.type].sellPrice) * 100).toFixed(2);
            const changeClass = priceChange >= 0 ? 'price-increase' : 'price-decrease';
            priceChangeHtml = `<span class="price-change ${changeClass}">(${priceChange >= 0 ? '+' : ''}${formatCurrency(priceChange)} / ${priceChangePercent}%)</span>`;
          }

          // Tạo dòng mới trong bảng
          const row = document.createElement('tr');
          row.className = 'price-card';

          // So sánh với giá cũ để highlight thay đổi
          if (lastPrices[product.type]) {
            if (product.sellPrice > lastPrices[product.type].sellPrice) {
              row.classList.add('price-up');
            } else if (product.sellPrice < lastPrices[product.type].sellPrice) {
              row.classList.add('price-down');
            }
          }

          row.innerHTML = `
            <td><span class="gold-type">${product.type}</span></td>
            <td class="text-end">${formatCurrency(product.buyPrice)}</td>
            <td class="text-end">${formatCurrency(product.sellPrice)} ${priceChangeHtml}</td>
            <td class="text-end">${formatCurrency(difference)} (${differencePercent}%)</td>
          `;

          tableBody.appendChild(row);

          // Lưu giá mới nhất vào cache
          lastPrices[product.type] = {
            buyPrice: product.buyPrice,
            sellPrice: product.sellPrice
          };
        });

        // Sau 2 giây, xóa các lớp highlight
        setTimeout(() => {
          document.querySelectorAll('.price-up, .price-down').forEach(el => {
            el.classList.remove('price-up', 'price-down');
          });
        }, 2000);
      } else {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Không có dữ liệu</td></tr>';
      }
    }

    // Kết nối Socket.io
    const socket = io();

    // Khi kết nối thành công
    socket.on('connect', function () {
      document.getElementById('connection-status').innerText = 'Đã kết nối';
      document.getElementById('connection-status').classList.remove('bg-danger');
      document.getElementById('connection-status').classList.add('bg-success');

      // Đăng ký theo dõi vendor
      socket.emit('join', vendorId);
    });

    // Khi mất kết nối
    socket.on('disconnect', function () {
      document.getElementById('connection-status').innerText = 'Mất kết nối';
      document.getElementById('connection-status').classList.remove('bg-success');
      document.getElementById('connection-status').classList.add('bg-danger');
    });

    // Nhận cập nhật giá thời gian thực
    socket.on('priceUpdate', function (data) {
      if (data && data.key === vendorId) {
        updateUI(data);
      }
    });

    // Error handling for socket connection
    socket.on('error', function (error) {
      console.error('Socket error:', error);
      document.getElementById('connection-status').innerText = 'Lỗi kết nối';
      document.getElementById('connection-status').classList.remove('bg-success');
      document.getElementById('connection-status').classList.add('bg-danger');
    });

    // Lấy dữ liệu ban đầu khi trang tải xong
    fetch(`/get/${vendorId}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Không thể lấy dữ liệu từ server');
        }
        return response.json();
      })
      .then(result => {
        if (result.success && result.data) {
          updateUI(result.data);
        }
      })
      .catch(error => {
        console.error('Lỗi:', error);
        document.getElementById('price-table-body').innerHTML =
          `<tr><td colspan="4" class="text-center text-danger">Lỗi: ${error.message}</td></tr>`;
      });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>